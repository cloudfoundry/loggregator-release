#!/bin/bash
set -ex

base_dir=$( cd "$( dirname "${BASH_SOURCE[0]}" )"/.. && pwd )

function finish {
  rm $base_dir/metron.zip $base_dir/metron.exe
}
trap finish EXIT

export GOOS=windows
export GOPATH=$base_dir

pushd $base_dir

go build -o metron.exe metron
zip metron.zip metron.exe
bosh add blob metron.zip metron_agent_windows

if [ -n "$ACCESS_KEY_ID" -a -n "$SECRET_ACCESS_KEY" ]; then
  cat > config/private.yml << EOF
---
blobstore:
  s3:
    access_key_id: $ACCESS_KEY_ID
    secret_access_key: $SECRET_ACCESS_KEY
EOF
  bosh -n upload blobs
  git config user.email "cf-netgarden-eng@pivotal.io"
  git config user.name "CI (Automated)"
  git commit config/blobs.yml -m "Update Windows bosh blobs"
else
  echo "No \$ACCESS_KEY_ID and \$SECRET_ACCESS_KEY provided, skipping blob upload/commit"
fi

popd

if [ -n "$OUTPUT_DIR" ]; then
  git clone $base_dir $OUTPUT_DIR
fi
